{% extends "user_admin/logged_in_base.html" %}
{% block content %}


<div class="full-height">
    <div class="container" id="content">
        <div class="row no-bottom-padding">
            <div class="col s12">
                <div class="top-section-padding"></div>
                <div class="card white-text grey darken-3 z-depth-0">
                    <div class="card-content">
                        <div class="row">
                            <div class="col s12">
                                <h3 class="white-text">
                                    New Snippet<i class="fas fa-code white-text right"></i>
                                </h3>
                            </div>
                        </div>

                        <div id="new-snippet-form-section">
                            <form action="/new-snippet-submit" method="POST" id="new-snippet-form">
                                <div class="row no-bottom-padding">
                                    <div id="sname">
                                        <div class="col s12 m12 l6 input-field">
                                            <i class="material-icons prefix ">title</i>
                                            {{ new_snippet_form.snippet_name(class="white-text", required="", maxlength="150", pattern=".{1,150}", title="Must be less than 150 characters.")}}
                                            {{ new_snippet_form.snippet_name.label }}
                                            
                                            <span class="red-text text-accent-1 helper-text" style="display: none;" id="name_error_text"></span>

                                            {% for error in new_snippet_form.snippet_name.errors %}
                                                <span class="red-text accent-1">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <div id="slang">
                                        <div class="col s12 m12 l6 input-field">
                                            <i class="material-icons prefix ">code</i>
                                            {{ new_snippet_form.language(class="white", required="", onchange="updateLanguage()")}}

                                            <span class="red-text text-accent-1 helper-text" style="display: none;" id="language_error_text"></span>
                                    
                                            {% for error in new_snippet_form.language.errors %}
                                                <span class="red-text accent-1">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row no-bottom-padding">
                                    <div id="sdesc">
                                        <div class="col s12 input-field">
                                            <i class="material-icons prefix ">description</i>
                                            {{ new_snippet_form.description(class="white-text materialize-textarea", required="", maxlength="1500", pattern=".{1,1500}", title="Must be less than 1500 characters.")}}
                                            {{ new_snippet_form.description.label }}

                                            <span class="red-text text-accent-1 helper-text" style="display: none;" id="description_error_text"></span>
                            
                                            {% for error in new_snippet_form.description.errors %}
                                                <span class="red-text accent-1">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <div class="row valign-wrapper hide-on-med-and-down" id="stagsnpin">
                                    <div class="col s12 m12 l6 no-padding-top input-field">
                                        <i class="material-icons prefix ">search</i>
                                        <div class="chips chips-placeholder white-text no-top-padding no-bottom-padding" id="tags"></div>
                                        <span class="red-text text-accent-1 helper-text" style="display: none;" id="tags_error_text"></span>
                                        <a href="#" onclick="tagsHelp()" style="color: #9e9e9e;"><i class="far fa-question-circle right help-text-top-padding"></i></a>
                                    </div>
                                
                                    <div class="col s12 m12 l6 center no-top-padding">
                                        <label>
                                            <input type="checkbox" class="filled-in white-text" name="pin" id="pin"/>
                                            <span class="white-text center">Pin to my favorites!</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="row hide-on-large-only" id="stagsnpin">
                                    <div class="col s12 m12 l6 no-padding-top input-field">
                                        <i class="material-icons prefix ">search</i>
                                        <div class="chips chips-placeholder white-text no-top-padding no-bottom-padding" id="tags"></div>
                                        <span class="red-text text-accent-1 helper-text" style="display: none;" id="tags_error_text"></span>
                                        <a href="#" onclick="tagsHelp()" style="color: #9e9e9e;"><i class="far fa-question-circle right"
                                                style="margin-top:.25rem !important;"></i></a>
                                    </div>
                                    
                                    <div class="col s12 m12 l6 center no-top-padding">
                                        <div class="section"></div>
                                        <label>
                                            <input type="checkbox" class="filled-in white-text" name="pin" id="pin" />
                                            <span class="white-text center">Pin to my favorites!</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col s12 input-field">
                                        <div class="section"></div>
                                        <textarea name="snippet" id="snippet" maxlength="50000", pattern=".{1,50000}"></textarea>
                                        <span class="red-text text-accent-1 helper-text help-text-top-padding" style="display: none;" id="snippet_error_text"></span>
                                    </div>
                                </div>

                                <div class="row" id="save-new-snippet-button-row">
                                    <div class="col s12">
                                        <div class="section"></div>
                                        <span class="right">
                                            <a href="/dashboard?vzin={{ session['vzin'] }}&username={{ session['username'].title() }}"
                                                class="purple darken-1 white-text waves-effect waves-light btn-flat">Cancel</a>&nbsp;
                                            <button type="submit" class="btn-flat purple darken-1 white-text waves-effect waves-light"
                                                id="snippet-submit-button">Save</button>
                                        </span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% assets 'snypit_admin_js' %}
    <script type="text/javascript" src="{{ ASSET_URL }}"></script>
{% endassets %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.chips');
        var instances = M.Chips.init(elems, {
            placeholder: 'Enter Tags',
            secondaryPlaceholder: '+Tags'
        });
    });
</script>

<script>
    M.AutoInit();
</script>

<script>
    var editor = CodeMirror.fromTextArea(document.getElementById('snippet'), {
        lineNumbers: true,
        mode: 'python',
        theme: "{{ session['editor_theme'] }}"
    });
</script>

<script type="text/javascript">
    function updateLanguage() {
        var selectBox = document.getElementById("language");
        var selectedLanguage = selectBox.options[selectBox.selectedIndex].value.split("&")[1];
        editor.setOption("mode", selectedLanguage);
    }
</script>

<script>
    function tagsHelp() {
        M.toast({ 
            html: '<p>To create a tag, type the tag content & press Enter.<br>To delete a tag, press Backspace twice.</p>',
            classes: 'grey darken-3 white-text',
            'displayLength': 6000 
        });
    };
</script>

<script>
        document.getElementById("new-snippet-form").addEventListener('submit', makeRequest);
        function makeRequest(e) {
            e.preventDefault();
            var xhr;
            var csrf_token = "{{ csrf_token() }}";
            /*var preloader = document.getElementById("forgot-pw-preloader");
            var formBtns = document.getElementById("forgot-pw-form-btns");
            var emailErrorText = document.getElementById('email-error-text');

            formBtns.style.display = 'none';
            preloader.style.display = "block";*/

            xhr = new XMLHttpRequest();
            xhr.open('POST', '/new-snippet-submit', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded')
            xhr.setRequestHeader("X-CSRFToken", csrf_token);
            var snippetName = document.getElementById('snippet_name').value;
            var snippetLanguage = document.getElementById('language').value.split("&")[0];
            var snippetDescription = document.getElementById('description').value;
            var snippetContent = document.getElementById('snippet').value;
            var nameErrorText = document.getElementById('name_error_text');
            var languageErrorText = document.getElementById('language_error_text');
            var descErrorText = document.getElementById('description_error_text');
            var tagsErrorText = document.getElementById('tags_error_text');
            var snippetErrorText = document.getElementById('snippet_error_text');

            var tags = '';
            var tagData = M.Chips.getInstance(document.getElementById('tags'));
            
            for (var i=0; i<tagData.chipsData.length; i++) {
                if (i === 0) {
                    tags = tagData.chipsData[i].tag;
                }

                else if (i !==0 && i !==tagData.chipsData.length - 1) {
                    tags = tags + "," + tagData.chipsData[i].tag;
                }

                else {
                    tags = tags + "," + tagData.chipsData[i].tag + "&";
                };
            };

            if (document.getElementById('pin').checked) {
                var pin = 'pin=True&';
            }
            else {
                var pin = 'pin=False&';
            };

            

            if (snippetLanguage === "none") {
                languageErrorText.style.display = 'block';
                languageErrorText.innerHTML = 'This field is required.'
                return false;
            }

            if (snippetContent == "") {
                snippetErrorText.style.display = 'block';
                snippetErrorText.innerHTML = 'This field is required.'
                return false;
            }

            if (tags.length > 500) {
                tagsErrorText.style.display = 'block';
                tagsErrorText.innerHTML = 'There are too many tags.';
                return false;
            }

            var name = "snippet_name=" + snippetName + "&";
            var language = "language=" + snippetLanguage + "&";
            var description = "description=" + snippetDescription + "&";
            var snippet = "snippet=" + snippetContent;
            var params = name + language + description + tags + pin + snippet;
            
            xhr.onload = function () {
                /*preloader.style.display = "none";
                formBtns.style.display = 'block';*/

                var r = JSON.parse(this.response);

                if (this.status === 200) {
                    alert('Success')
                }

                else if (this.status === 400) {

                    if (r.hasOwnProperty('errors')) {
                        if (r.errors.hasOwnProperty('forgot_password_email')) {
                            if (r.errors.forgot_password_email === 'unconfirmed_email') {
                                window.location.href = '/email-confirmation-sent?email=' + document.getElementById('forgot_password_email').value;
                            }
                            emailErrorText.style.display = 'block';
                            emailErrorText.innerHTML = r.errors.forgot_password_email;
                        }
                    }
                }
            };
            xhr.onerror = function () {
                formBtns.style.display = 'block';
                preloader.style.display = 'none';
                M.toast({ html: '<p><i class="fas fa-2x fa-exclamation-triangle red-text text-accent-1 center"></i></p> &nbsp;&nbsp;&nbsp;<p>An error occured submitting the form.</p>', classes: 'grey darken-3 white-text center' })
            };
            xhr.send(params);
        };
</script>
{#<script>
    $(document).ready(function (e) {

            $('#new-snippet-form').on('submit', function (e) {
                e.preventDefault();

                if (document.getElementById('language').value === 'none&none') {
                    M.toast({ html: '<p>Please Choose a Language</p>', classes: 'grey darken-3 white-text flow-text button-border-purple z-depth-5' });
                    return;
                };

                var tagData = M.Chips.getInstance(document.getElementById('tags'));
                document.getElementById('tag-input').value = JSON.stringify(tagData.chipsData);

                new_snippet_request = $.ajax({
                    url: '/new-snippet-submit',
                    type: 'POST',
                    data: $('#new-snippet-form').serialize(),
                    success: function (response) {
                        if (response.redirect) {
                            window.location.href = response.redirect;
                        }

                        else if (response.added) {
                            M.toast({ html: '<p>Snippet Saved!</p>', classes: 'grey darken-3 white-text flow-text button-border-purple z-depth-5' });
                            $('#snippet-id').val(response.added);

                            document.getElementById('snippet-submit-button').setAttribute('disabled', true);
                            document.getElementById('save-new-snippet-button-row').style.display = 'none';
                            document.getElementById('sname').innerHTML = "<div class='col s12 m12 l8'><h4 class='white-text'>" + response.snippet_name + "</h4></div>"
                            document.getElementById('slang').innerHTML = "<div class='col s12 m12 l4'><h4 class='white-text right'>" + response.snippet_language + "</h4></div>"
                            document.getElementById('sdesc').innerHTML = "<div class='col s12 m12 l12'><p class='grey-text text-lighten-2 flow-text'>" + response.snippet_description + "</p><div class='section'></div></div>"
                            document.getElementById('stagsnpin').style.display = 'none';
                            document.getElementById('another-snippet-row').style.display = 'block';
                        }

                        else if (response.update) {
                            M.toast({ html: '<p>Snippet Updated!</p>', classes: 'grey darken-3 white-text flow-text button-border-purple z-depth-5' });

                            document.getElementById('snippet-submit-button').setAttribute('disabled', true);
                        }
                    }
                });

                var csrf_token = "{{ csrf_token() }}";

                $.ajaxSetup({
                    beforeSend: function (xhr, settings) {
                        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                            xhr.setRequestHeader("X-CSRFToken", csrf_token);
                        }
                    }
                });
            });
        });
</script>#}


{% endblock %}